<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ESBAS - Simulador Profesional</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* --- SYSTEM TOKENS --- */
        :root {
            --primary: #B91C1C;
            --primary-dark: #991B1B;
            --accent-gold: #D97706;
            --accent-green: #059669;
            --bg-body: #F3F4F6;
            --bg-card: #FFFFFF;
            --text-main: #111827;
            --text-muted: #6B7280;
            --radius: 12px;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg-body); color: var(--text-main); font-family: 'Inter', sans-serif; margin: 0; padding-bottom: 40px; }
        button, input, textarea, select { font-family: inherit; outline: none; }
        h1, h2, h3, h4 { margin: 0; }
        svg { display: block; }

        .container { max-width: 1000px; margin: 0 auto; padding: 0 20px; }

        /* --- ANIMACIONES --- */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes popIn { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        /* --- NAVBAR --- */
        .navbar { 
            background: var(--bg-card); border-bottom: 1px solid #E5E7EB; padding: 12px 0; 
            position: sticky; top: 0; z-index: 50; box-shadow: var(--shadow-sm);
            animation: slideUp 0.5s ease;
        }
        .nav-inner { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        
        .brand { display: flex; flex-direction: column; line-height: 1.1; cursor: default; }
        .brand-main { font-weight: 800; font-size: 1.1rem; color: var(--primary); letter-spacing: -0.5px; }
        .brand-sub { font-size: 0.75rem; color: var(--text-muted); font-weight: 500; letter-spacing: 0.5px; }

        .nav-items { display: flex; gap: 8px; align-items: center; }
        
        /* --- BOTONES --- */
        .btn { 
            padding: 9px 16px; border-radius: 8px; font-size: 0.85rem; font-weight: 600; 
            cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 8px; 
            transition: var(--transition); position: relative; overflow: hidden; justify-content: center;
        }
        .btn:active { transform: scale(0.97); }

        .btn-secondary { background: #E5E7EB; color: #374151; }
        .btn-secondary:hover { background: #D1D5DB; color: #111; }
        
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 2px 4px rgba(185, 28, 28, 0.2); }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-1px); }
        
        .btn-icon { padding: 8px; border-radius: 50%; width: 36px; height: 36px; background: transparent; color: var(--text-muted); }
        .btn-icon:hover { background: #F3F4F6; color: var(--primary); transform: rotate(15deg); }
        
        .btn-mega {
            background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
            color: white; box-shadow: 0 4px 6px rgba(217, 119, 6, 0.3);
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .btn-mega:hover { box-shadow: 0 8px 15px rgba(217, 119, 6, 0.4); transform: translateY(-1px); }

        /* --- VISTAS --- */
        .view { display: none; }
        .view.active { display: block; }

        /* --- DASHBOARD STATS --- */
        .stats-bar {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px;
            animation: fadeIn 0.5s ease;
        }
        .stat-item {
            background: white; padding: 15px; border-radius: 10px; border: 1px solid #E5E7EB;
            display: flex; align-items: center; justify-content: space-between; box-shadow: var(--shadow-sm);
        }
        .stat-info { text-align: left; }
        .stat-num { display: block; font-size: 1.4rem; font-weight: 800; color: var(--text-main); line-height: 1; }
        .stat-lbl { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; font-weight: 600; margin-top: 4px; }
        .stat-icon { color: #D1D5DB; width: 24px; height: 24px; }

        /* --- GRID TARJETAS --- */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px; }

        .card-wrapper { 
            height: 260px; perspective: 1000px; position: relative; 
            animation: slideUp 0.5s ease backwards;
        }
        
        .card-inner {
            position: relative; width: 100%; height: 100%;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            transform-style: preserve-3d; border-radius: var(--radius);
            box-shadow: var(--shadow-md); background: var(--bg-card);
        }
        .card-wrapper:not(.hover-blocked):hover .card-inner { transform: rotateY(180deg); }

        .card-face {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden; border-radius: var(--radius);
            padding: 25px; padding-bottom: 60px;
            display: flex; flex-direction: column;
            overflow-y: auto; scrollbar-width: thin;
        }
        .face-front { background: var(--bg-card); border: 1px solid #E5E7EB; }
        .face-back { background: #1F2937; color: white; transform: rotateY(180deg); align-items: center; justify-content: center; text-align: center; }
        
        .card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; }
        .card-badge { 
            font-size: 0.65rem; font-weight: 700; text-transform: uppercase; 
            padding: 4px 8px; border-radius: 6px; letter-spacing: 0.5px;
            display: flex; align-items: center; gap: 6px;
        }
        .card-lec { font-family: monospace; font-size: 0.75rem; color: var(--text-muted); background: #F3F4F6; padding: 2px 6px; border-radius: 4px; }
        .card-q { font-weight: 600; font-size: 1.05rem; line-height: 1.5; color: #111; }
        
        .card-actions {
            position: absolute; bottom: 15px; right: 15px; z-index: 100;
            display: flex; gap: 8px;
        }
        .action-icon {
            width: 34px; height: 34px; border-radius: 50%; background: white; border: 1px solid #E5E7EB;
            display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-muted);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: 0.2s;
        }
        .action-icon:hover { transform: scale(1.1); color: var(--primary); border-color: var(--primary); }
        .action-icon.delete:hover { color: #DC2626; border-color: #DC2626; }

        /* --- FORMULARIO --- */
        .form-box { 
            background: var(--bg-card); border-radius: 16px; padding: 30px; 
            max-width: 650px; margin: 0 auto; box-shadow: var(--shadow-md); 
            border: 1px solid #E5E7EB; animation: slideUp 0.3s ease;
        }
        .input { width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 0.95rem; background: #F9FAFB; transition: 0.2s; }
        .input:focus { background: white; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(185, 28, 28, 0.1); }
        .opt-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }

        /* --- MODALES --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 2000;
            display: none; align-items: center; justify-content: center;
            backdrop-filter: blur(4px); opacity: 0; transition: opacity 0.2s;
        }
        .modal-overlay.open { display: flex; opacity: 1; }
        
        .modal-box {
            background: white; width: 90%; max-width: 500px;
            padding: 30px; border-radius: 16px; box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            text-align: center; transform: scale(0.95); transition: transform 0.2s;
        }
        .modal-overlay.open .modal-box { transform: scale(1); }
        
        /* SIMULADOR SELECCIÓN */
        .sim-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px; margin-bottom: 20px; }
        .sim-option-box {
            padding: 15px; border: 2px solid #E5E7EB; border-radius: 10px;
            cursor: pointer; transition: 0.2s; background: #FAFAFA; text-align: left;
            display: flex; flex-direction: column; gap: 5px;
        }
        .sim-option-box:hover { border-color: #D1D5DB; background: #F3F4F6; }
        .sim-option-box.selected { border-color: var(--primary); background: #FEF2F2; box-shadow: 0 0 0 2px rgba(185, 28, 28, 0.1); }
        .sim-opt-title { font-weight: 700; font-size: 0.9rem; color: var(--text-main); }
        .sim-opt-desc { font-size: 0.75rem; color: var(--text-muted); }

        /* BOTONES DE LECCIÓN (NUEVO) */
        .lesson-grid { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-top: 15px; animation: popIn 0.3s ease; }
        .lesson-btn {
            width: 40px; height: 40px; border-radius: 8px; border: 1px solid #E5E7EB;
            background: white; color: var(--text-main); font-weight: 600; font-size: 0.9rem;
            cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center;
        }
        .lesson-btn:hover { border-color: var(--primary); color: var(--primary); transform: translateY(-2px); }
        .lesson-btn.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 6px rgba(185, 28, 28, 0.3); }
        .lesson-btn.all-btn { width: auto; padding: 0 15px; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; }

        /* SIMULADOR PREGUNTAS */
        .sim-container { max-width: 700px; margin: 0 auto; animation: slideUp 0.4s ease; }
        .option-card {
            background: white; padding: 18px; border-radius: 10px; border: 1px solid #E5E7EB;
            margin-bottom: 12px; cursor: pointer; display: flex; align-items: center; gap: 15px;
            transition: 0.2s;
        }
        .option-card:hover { border-color: #9CA3AF; background: #F9FAFB; transform: translateX(4px); }
        .option-card.correct { border-color: var(--accent-green); background: #ECFDF5; color: #064E3B; }
        .option-card.wrong { border-color: var(--primary); background: #FEF2F2; color: #7F1D1D; }

        /* RESULTADOS */
        .res-circle { 
            width: 120px; height: 120px; border-radius: 50%; border: 8px solid #F3F4F6; margin: 0 auto 20px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .res-score { font-size: 2.2rem; font-weight: 800; color: var(--text-main); line-height: 1; }
        
        /* TOAST */
        .toast { 
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(20px); 
            background: #1F2937; color: white; padding: 12px 24px; border-radius: 30px; 
            z-index: 3000; opacity: 0; pointer-events: none; transition: 0.3s; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.2); font-size: 0.9rem;
        }
        .toast.show { opacity: 1; transform: translateY(0) translateX(-50%); }
        .toast.success { background: #059669; }
        .toast.error { background: #B91C1C; }
    </style>
</head>
<body>

<nav class="navbar">
    <div class="container nav-inner">
        <div class="brand">
            <span class="brand-main">ESBAS</span>
            <span class="brand-sub">SIMULADOR DE EXÁMENES</span>
        </div>
        <div class="nav-items">
            <button onclick="showList()" class="btn btn-secondary">
                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h16"></path></svg>
                Base
            </button>
            <button onclick="showCreate()" class="btn btn-primary">
                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4"></path></svg>
                Nuevo
            </button>
            <button onclick="openSimModal()" class="btn btn-mega">
                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                Simulacro
            </button>
            <button onclick="openConfig()" class="btn btn-icon" title="Configurar">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
            </button>
        </div>
    </div>
</nav>

<div class="container">
    <div id="toast" class="toast"><span id="toastMsg">Mensaje</span></div>

    <div id="loader" style="text-align:center; padding: 80px 0;">
        <div style="width:40px; height:40px; border:4px solid #E5E7EB; border-top-color:var(--primary); border-radius:50%; animation: spin 1s infinite linear; margin:0 auto;"></div>
        <p style="color:#9CA3AF; margin-top:20px;">Iniciando sistema...</p>
    </div>

    <div id="listView" class="view">
        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-info"><span class="stat-num" id="statTotal">0</span><span class="stat-lbl">Total Preguntas</span></div>
                <svg class="stat-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
            </div>
            <div class="stat-item">
                <div class="stat-info"><span class="stat-num" id="statM1">0</span><span class="stat-lbl" id="statLblM1">M1</span></div>
                <svg class="stat-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z"></path></svg>
            </div>
            <div class="stat-item">
                <div class="stat-info"><span class="stat-num" id="statM2">0</span><span class="stat-lbl" id="statLblM2">M2</span></div>
                <svg class="stat-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>
            </div>
        </div>

        <div class="grid" id="cardGrid"></div>
        
        <div id="emptyMsg" style="text-align:center; padding: 60px; display:none;">
            <h3 style="color:#374151;">Sin registros</h3>
            <p style="color:#9CA3AF;">Base de datos vacía.</p>
        </div>
    </div>

    <div id="formView" class="view" style="padding-top: 40px;">
        <div class="form-box">
            <div class="form-header" style="margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid #F3F4F6; display: flex; justify-content: space-between; align-items: center;">
                <div class="form-title" id="formTitle" style="font-size: 1.25rem; font-weight: 700;">Registro</div>
                <div id="formBadge" style="font-size:0.75rem; background:#ECFDF5; color:#065F46; padding:4px 10px; border-radius:20px;">NUEVO</div>
            </div>
            <div class="input-group" style="display:grid; grid-template-columns: 2fr 1fr; gap:15px; margin-bottom:20px;">
                <div>
                    <label class="label">Módulo</label>
                    <select id="inpMod" class="input"></select>
                </div>
                <div>
                    <label class="label">Lección</label>
                    <input type="number" id="inpLec" class="input" placeholder="#">
                </div>
            </div>
            <div class="input-group" style="margin-bottom:20px;">
                <label class="label">Pregunta</label>
                <textarea id="inpQ" class="input" rows="3" placeholder="Planteamiento..."></textarea>
            </div>
            <div class="input-group" style="margin-bottom:20px;">
                <label class="label">Alternativas</label>
                <div id="optList" style="background:#F9FAFB; padding:15px; border-radius:8px; border:1px solid #E5E7EB;"></div>
                <button onclick="addOpt()" class="btn btn-secondary" style="width:100%; margin-top:10px; background:white; border:1px dashed #D1D5DB;">
                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4"></path></svg>
                    Agregar Opción
                </button>
            </div>
            <div style="display:flex; gap:15px; margin-top:30px;">
                <button onclick="saveData()" id="btnSave" class="btn btn-primary" style="flex:1;">Guardar</button>
                <button onclick="showList()" class="btn btn-secondary">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="simView" class="view" style="padding-top: 40px;">
        <div class="sim-container">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px; align-items:center;">
                <span id="simTag" style="background:#333; color:white; padding:4px 10px; border-radius:6px; font-size:0.8rem; font-weight:700;">EXAMEN</span>
                <span id="simCount" style="color:#6B7280; font-family:monospace;">1/10</span>
            </div>
            <h2 id="simQ" style="font-size:1.5rem; margin-bottom:30px; color:#111;">...</h2>
            <div id="simOpts"></div>
            <div id="simNext" style="text-align:right; margin-top:30px; display:none;">
                <button onclick="nextSim()" class="btn btn-primary">
                    Siguiente
                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                </button>
            </div>
            <button onclick="showList()" class="btn btn-secondary" style="margin-top:50px;">Salir</button>
        </div>
    </div>

    <div id="resultView" class="view" style="padding-top: 40px;">
        <div class="form-box" style="text-align:center; max-width: 500px;">
            <h2 style="margin-bottom: 25px;">Resultados</h2>
            <div class="res-circle" id="resCircle">
                <span class="res-score" id="finalScore">0%</span>
                <span style="font-size:0.75rem; color:#6B7280; text-transform:uppercase;">Puntaje</span>
            </div>
            <p id="resMsg" style="color:var(--text-muted); font-weight:500;">...</p>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin:30px 0;">
                <div style="background:#F0FDF4; padding:15px; border-radius:10px;">
                    <span style="display:block; font-size:1.5rem; font-weight:700; color:#166534;" id="resOk">0</span>
                    <span style="font-size:0.7rem; text-transform:uppercase; color:#166534;">Correctas</span>
                </div>
                <div style="background:#FEF2F2; padding:15px; border-radius:10px;">
                    <span style="display:block; font-size:1.5rem; font-weight:700; color:#991B1B;" id="resFail">0</span>
                    <span style="font-size:0.7rem; text-transform:uppercase; color:#991B1B;">Incorrectas</span>
                </div>
            </div>
            <div id="resAdvice" style="background:#EFF6FF; color:#1E40AF; padding:15px; border-radius:8px; font-size:0.9rem; margin-bottom:25px; border:1px solid #DBEAFE;"></div>
            <button onclick="showList()" class="btn btn-primary" style="width:100%;">Finalizar</button>
        </div>
    </div>
</div>

<div id="configModal" class="modal-overlay">
    <div class="modal-box">
        <h2 style="margin-top:0;">Renombrar Módulos</h2>
        <p style="color:#6B7280; margin-bottom:20px;">Personaliza las etiquetas</p>
        <div style="text-align:left; margin-bottom:15px;">
            <label class="label">Módulo 1</label>
            <input type="text" id="cfgM1" class="input">
        </div>
        <div style="text-align:left; margin-bottom:15px;">
            <label class="label">Módulo 2</label>
            <input type="text" id="cfgM2" class="input">
        </div>
        <div style="text-align:left; margin-bottom:25px;">
            <label class="label">Módulo 3</label>
            <input type="text" id="cfgM3" class="input">
        </div>
        <button onclick="saveConfig()" class="btn btn-primary" style="width:100%;">Guardar Cambios</button>
    </div>
</div>

<div id="simModal" class="modal-overlay">
    <div class="modal-box">
        <h2 style="margin-top:0;">Configurar Simulacro</h2>
        <p style="color:#6B7280; margin-bottom:20px;">1. Selecciona el Módulo</p>
        
        <div class="sim-grid">
            <div class="sim-option-box" onclick="selectSimMode('all', this)" style="grid-column: span 2;">
                <span class="sim-opt-title">Repaso General</span>
                <span class="sim-opt-desc">Mezcla de todo</span>
            </div>
            <div class="sim-option-box" onclick="selectSimMode('m1', this)">
                <span class="sim-opt-title" id="lblSimM1">M1</span>
            </div>
            <div class="sim-option-box" onclick="selectSimMode('m2', this)">
                <span class="sim-opt-title" id="lblSimM2">M2</span>
            </div>
            <div class="sim-option-box" onclick="selectSimMode('m3', this)">
                <span class="sim-opt-title" id="lblSimM3">M3</span>
            </div>
        </div>

        <div id="lessonSelectorBox" style="text-align:left; margin-top:20px; opacity:0.5; pointer-events:none; transition:0.3s;">
            <label class="label">2. Selecciona Lección <span style="font-weight:400; color:#9CA3AF;">(Opcional)</span></label>
            <div id="lessonButtonsContainer" class="lesson-grid">
                </div>
        </div>
        
        <div style="margin-top:25px; display:flex; gap:10px;">
            <button onclick="startSimAction()" class="btn btn-primary" style="flex:1;">INICIAR EXAMEN</button>
            <button onclick="closeSimModal()" class="btn btn-secondary">Cancelar</button>
        </div>
    </div>
</div>

<script>
    const BIN_ID = '696a7f22ae596e708fe10d1b';
    const API_KEY = '$2a$10$7PwFegDVLzoS8bJTQPdA7.27bk7D4odCTFnynWW1NkB5H6.PBt.nm';
    
    let db = [];
    let editId = null;
    let moduleNames = JSON.parse(localStorage.getItem('esbas_modules')) || { m1: "Incendios", m2: "Médicos", m3: "Matpel" };
    
    // Variables de Simulacro
    let selectedSimMode = null; 
    let selectedSimLesson = 'all';
    let simSession = { q: [], idx: 0, score: 0, mistakes: {} };

    // --- TECLADO ESC ---
    document.addEventListener('keydown', (e) => {
        if(e.key === 'Escape') {
            closeSimModal(); closeConfig(); showList();
        }
    });

    window.onload = async () => {
        updateUILabels();
        try {
            const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, { headers: {'X-Master-Key': API_KEY} });
            const data = await res.json();
            db = Array.isArray(data.record) ? data.record : [];
            document.getElementById('loader').style.display = 'none';
            showList();
        } catch(e) { alert('Error cargando datos'); }
    };

    async function sync() {
        showToast('Sincronizando...', 'info');
        await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
            method: 'PUT', headers: {'Content-Type':'application/json', 'X-Master-Key':API_KEY}, body: JSON.stringify(db)
        });
        showToast('Datos guardados', 'success');
    }

    /* --- CONFIG --- */
    window.openConfig = () => {
        document.getElementById('configModal').classList.add('open');
        document.getElementById('cfgM1').value = moduleNames.m1;
        document.getElementById('cfgM2').value = moduleNames.m2;
        document.getElementById('cfgM3').value = moduleNames.m3;
    }
    window.closeConfig = () => document.getElementById('configModal').classList.remove('open');
    
    window.saveConfig = () => {
        moduleNames.m1 = document.getElementById('cfgM1').value || "M1";
        moduleNames.m2 = document.getElementById('cfgM2').value || "M2";
        moduleNames.m3 = document.getElementById('cfgM3').value || "M3";
        localStorage.setItem('esbas_modules', JSON.stringify(moduleNames));
        updateUILabels();
        closeConfig();
        showToast("Configuración guardada", 'success');
        if(document.getElementById('listView').classList.contains('active')) renderGrid();
    }

    function updateUILabels() {
        // Stats
        document.getElementById('statLblM1').innerText = moduleNames.m1;
        document.getElementById('statLblM2').innerText = moduleNames.m2;
        
        // Form Select
        const sel = document.getElementById('inpMod');
        sel.innerHTML = `<option value="m1">${moduleNames.m1}</option><option value="m2">${moduleNames.m2}</option><option value="m3">${moduleNames.m3}</option>`;
        
        // Sim Modal Labels
        document.getElementById('lblSimM1').innerText = moduleNames.m1;
        document.getElementById('lblSimM2').innerText = moduleNames.m2;
        document.getElementById('lblSimM3').innerText = moduleNames.m3;
    }

    /* --- NAV --- */
    function switchView(id) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        window.scrollTo(0, 0);
    }
    function showList() { switchView('listView'); renderGrid(); }
    function showCreate() { switchView('formView'); resetForm(); }

    /* --- GRID --- */
    function renderGrid() {
        const grid = document.getElementById('cardGrid');
        grid.innerHTML = '';
        
        let stats = { total: db.length, m1:0, m2:0, m3:0 };
        db.forEach(i => { if(stats[i.module] !== undefined) stats[i.module]++; });
        document.getElementById('statTotal').innerText = stats.total;
        document.getElementById('statM1').innerText = stats.m1;
        document.getElementById('statM2').innerText = stats.m2;

        if(db.length === 0) { document.getElementById('emptyMsg').style.display='block'; return; }
        document.getElementById('emptyMsg').style.display='none';

        const sorted = [...db].sort((a,b) => a.id - b.id);

        sorted.forEach((item, index) => {
            let bg='#F3F4F6', txt='#374151', lbl='GEN', iconPath='';
            if(item.module==='m1'){ 
                bg='#FEF2F2'; txt='#B91C1C'; lbl=moduleNames.m1; 
                iconPath='<path d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z" />';
            }
            if(item.module==='m2'){ 
                bg='#ECFDF5'; txt='#047857'; lbl=moduleNames.m2; 
                iconPath='<path d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />';
            }
            if(item.module==='m3'){ 
                bg='#FFFBEB'; txt='#B45309'; lbl=moduleNames.m3; 
                iconPath='<path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />';
            }

            const el = document.createElement('div');
            el.className = 'card-wrapper';
            el.style.animationDelay = `${index * 0.05}s`;
            el.innerHTML = `
                <div class="card-inner">
                    <div class="card-face face-front">
                        <div class="card-header">
                            <span class="card-badge" style="background:${bg}; color:${txt};">
                                <svg width="12" height="12" fill="currentColor" viewBox="0 0 24 24">${iconPath}</svg>
                                ${lbl}
                            </span>
                            <span class="card-lec">Lecc. ${item.lesson}</span>
                        </div>
                        <div class="card-q">${item.question}</div>
                    </div>
                    <div class="card-face face-back">
                        <div style="font-size:0.75rem; text-transform:uppercase; opacity:0.6;">Respuesta</div>
                        <div style="font-size:1.1rem; font-weight:700; color:#F59E0B; margin-top:8px;">
                            ${item.options[item.correctIndex] || '?'}
                        </div>
                    </div>
                </div>
                <div class="card-actions" onmouseenter="blockFlip(this)" onmouseleave="unblockFlip(this)">
                    <div class="action-icon" onclick="prepareEdit(${item.id})" title="Editar">
                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                    </div>
                    <div class="action-icon delete" onclick="deleteItem(${item.id})" title="Eliminar">
                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </div>
                </div>
            `;
            grid.appendChild(el);
        });
    }
    window.blockFlip = (el) => el.parentElement.classList.add('hover-blocked');
    window.unblockFlip = (el) => el.parentElement.classList.remove('hover-blocked');

    /* --- FORM --- */
    function addOpt(val='', checked=false) {
        const div = document.createElement('div');
        div.className = 'opt-row';
        div.innerHTML = `
            <input type="radio" name="correct" style="width:20px; height:20px; accent-color:var(--primary);" ${checked?'checked':''}>
            <input type="text" class="input opt-val" value="${val}" placeholder="Opción">
            <button onclick="this.parentElement.remove()" style="border:none; background:none; color:#EF4444; cursor:pointer;">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        `;
        document.getElementById('optList').appendChild(div);
    }

    function resetForm() {
        document.getElementById('formTitle').innerText = 'Nuevo Registro';
        document.getElementById('btnSave').innerText = 'Guardar';
        document.getElementById('inpMod').value = 'm1';
        document.getElementById('inpLec').value = '';
        document.getElementById('inpQ').value = '';
        document.getElementById('optList').innerHTML = '';
        addOpt(); addOpt();
    }

    window.prepareEdit = (id) => {
        const item = db.find(x => x.id === id);
        if(!item) return;
        editId = id;
        switchView('formView');
        document.getElementById('formTitle').innerText = 'Editar Registro';
        document.getElementById('btnSave').innerText = 'Actualizar';
        document.getElementById('inpMod').value = item.module;
        document.getElementById('inpLec').value = item.lesson;
        document.getElementById('inpQ').value = item.question;
        document.getElementById('optList').innerHTML = '';
        item.options.forEach((opt, i) => addOpt(opt, i===item.correctIndex));
    }

    window.saveData = async () => {
        const mod = document.getElementById('inpMod').value;
        const lec = document.getElementById('inpLec').value;
        const q = document.getElementById('inpQ').value;
        let opts = [], correctIdx = -1, radioIdx = -1;
        document.querySelectorAll('input[name="correct"]').forEach((r, i) => { if(r.checked) radioIdx = i; });
        document.querySelectorAll('.opt-val').forEach(inp => { if(inp.value.trim()) opts.push(inp.value.trim()); });
        if(radioIdx > -1 && radioIdx < opts.length) correctIdx = radioIdx;

        if(!lec || !q || opts.length < 2 || correctIdx === -1) { alert('Complete los datos'); return; }

        const record = { id: editId || Date.now(), module: mod, lesson: parseInt(lec), question: q, options: opts, correctIndex: correctIdx };
        let temp = [...db];
        if(editId) {
            const idx = temp.findIndex(x => x.id === editId);
            if(idx > -1) temp[idx] = record;
        } else { temp.push(record); }
        db = temp;
        await sync();
        showList();
    }

    window.deleteItem = async (id) => {
        if(confirm('¿Eliminar?')) {
            db = db.filter(x => x.id !== id);
            await sync();
            renderGrid();
        }
    }

    /* --- SIMULADOR AVANZADO --- */
    window.openSimModal = () => {
        document.getElementById('simModal').classList.add('open');
        selectSimMode(null, null); // Reset UI
    }
    window.closeSimModal = () => document.getElementById('simModal').classList.remove('open');

    window.selectSimMode = (mode, el) => {
        selectedSimMode = mode;
        selectedSimLesson = 'all'; // Reset lesson filter

        // Visual Selection
        document.querySelectorAll('.sim-option-box').forEach(b => b.classList.remove('selected'));
        if(el) el.classList.add('selected');
        
        const selectorBox = document.getElementById('lessonSelectorBox');
        const container = document.getElementById('lessonButtonsContainer');
        container.innerHTML = '';

        // Solo mostrar selector si no es "General" y si hay un modo seleccionado
        if(mode && mode !== 'all') {
            selectorBox.style.opacity = '1';
            selectorBox.style.pointerEvents = 'auto';

            // 1. Encontrar lecciones únicas para este módulo
            const lessons = [...new Set(db.filter(x => x.module === mode).map(x => x.lesson))].sort((a,b) => a-b);

            if(lessons.length === 0) {
                container.innerHTML = '<span style="font-size:0.8rem; color:#991B1B;">No hay preguntas registradas en este módulo.</span>';
            } else {
                // 2. Crear botón "TODO"
                const allBtn = document.createElement('div');
                allBtn.className = 'lesson-btn all-btn active'; // Activo por defecto
                allBtn.innerText = 'TODO';
                allBtn.onclick = () => selectLesson('all', allBtn);
                container.appendChild(allBtn);

                // 3. Crear botones numéricos
                lessons.forEach(l => {
                    const btn = document.createElement('div');
                    btn.className = 'lesson-btn';
                    btn.innerText = l;
                    btn.onclick = () => selectLesson(l, btn);
                    container.appendChild(btn);
                });
            }

        } else {
            selectorBox.style.opacity = '0.5';
            selectorBox.style.pointerEvents = 'none';
        }
    }

    window.selectLesson = (lesson, el) => {
        selectedSimLesson = lesson;
        // Visual Update
        document.querySelectorAll('.lesson-btn').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
    }

    window.startSimAction = () => {
        if(!selectedSimMode) { showToast('Selecciona un área', 'error'); return; }
        
        let pool = db;
        // Filtrar por módulo
        if(selectedSimMode !== 'all') {
            pool = db.filter(x => x.module === selectedSimMode);
            // Filtrar por lección específica si no es 'all'
            if(selectedSimLesson !== 'all') {
                pool = pool.filter(x => x.lesson == selectedSimLesson);
            }
        }
        
        if(pool.length === 0) { 
            showToast('No hay preguntas disponibles', 'error'); 
            return; 
        }

        simSession.q = pool.sort(() => Math.random() - 0.5);
        simSession.idx = 0;
        simSession.score = 0;
        simSession.mistakes = { m1: 0, m2: 0, m3: 0 };
        
        closeSimModal();
        switchView('simView');
        renderSim();
    }

    function renderSim() {
        const item = simSession.q[simSession.idx];
        document.getElementById('simQ').innerText = item.question;
        document.getElementById('simCount').innerText = `${simSession.idx + 1} / ${simSession.q.length}`;
        document.getElementById('simNext').style.display = 'none';
        
        const div = document.getElementById('simOpts');
        div.innerHTML = '';
        item.options.forEach((opt, i) => {
            const btn = document.createElement('div');
            btn.className = 'option-card';
            btn.innerHTML = `<div style="font-weight:700; color:#9CA3AF;">${String.fromCharCode(65+i)}</div><div>${opt}</div>`;
            btn.onclick = () => checkSimAnswer(btn, i, item);
            div.appendChild(btn);
        });
    }

    function checkSimAnswer(btn, i, item) {
        if(document.querySelector('.option-card.correct')) return;
        const parent = document.getElementById('simOpts');
        if(i === item.correctIndex) {
            btn.classList.add('correct');
            simSession.score++;
            showToast('¡Correcto!', 'success');
        } else {
            btn.classList.add('wrong');
            parent.children[item.correctIndex].classList.add('correct');
            showToast('Incorrecto', 'error');
            if(simSession.mistakes[item.module] !== undefined) simSession.mistakes[item.module]++;
        }
        document.getElementById('simNext').style.display = 'block';
    }

    window.nextSim = () => {
        if(simSession.idx < simSession.q.length - 1) {
            simSession.idx++;
            renderSim();
        } else {
            showResults();
        }
    }

    function showResults() {
        switchView('resultView');
        const total = simSession.q.length;
        const score = simSession.score;
        const pct = Math.round((score / total) * 100);
        
        document.getElementById('finalScore').innerText = pct + "%";
        document.getElementById('resOk').innerText = score;
        document.getElementById('resFail').innerText = total - score;
        
        const circle = document.getElementById('resCircle');
        if(pct >= 80) circle.style.borderColor = "#10B981";
        else if(pct >= 60) circle.style.borderColor = "#F59E0B";
        else circle.style.borderColor = "#B91C1C";
        
        let msg = "", advice = "";
        if(pct === 100) msg = "¡Perfecto!";
        else if(pct >= 80) msg = "¡Excelente!";
        else if(pct >= 60) msg = "Aprobado";
        else msg = "Repasar";
        document.getElementById('resMsg').innerText = msg;
        
        if(total - score > 0) {
            let maxErr = -1, weakMod = "";
            for (const [mod, count] of Object.entries(simSession.mistakes)) {
                if(count > maxErr) { maxErr = count; weakMod = mod; }
            }
            if(maxErr > 0) advice = `Recomendación: Repasar <strong>${moduleNames[weakMod]}</strong>`;
            else advice = "Revisar errores puntuales.";
        } else {
            advice = "¡Listo para el servicio!";
        }
        document.getElementById('resAdvice').innerHTML = advice;
    }

    function showToast(msg, type='info') {
        const t = document.getElementById('toast');
        t.className = `toast ${type}`;
        document.getElementById('toastMsg').innerText = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 2000);
    }
    
    // CSS extra
    const styleSheet = document.createElement("style");
    styleSheet.innerText = `
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hover-blocked .card-inner { transform: rotateY(0deg) !important; }
    `;
    document.head.appendChild(styleSheet);
</script>
</body>
</html>
